# PDF重命名工具 - 数字签名使用说明

## 架构概述

本项目采用**现代化签名模块 + 智能配置系统**的架构：

- **核心模块**: `code_signer/` - 现代化的代码签名核心模块
- **配置系统**: 智能配置加载器 - 支持多种配置格式和优先级
- **传统兼容**: `signing_tool.py` - 保持向后兼容的签名工具
- **项目入口**: `PDF签名工具.py` - 项目专用的签名界面

## 新配置系统特点

### 智能配置加载器
自动按优先级加载配置：
1. 指定的配置文件路径
2. `code_signer/examples/project_config.py` (推荐)
3. `signature_config.json` (兼容模式)
4. 内置默认配置

### 配置格式支持
- **Python配置文件** (推荐): 类型安全，支持验证
- **JSON配置文件**: 向后兼容，支持旧系统迁移

## 配置文件使用

### 方式1：Python配置文件 (推荐)

**配置文件位置**: `code_signer/examples/project_config.py`

```python
# -*- coding: utf-8 -*-
"""
PDF重命名工具项目专用配置
"""
from code_signer.config import SigningConfig, CertificateConfig, ToolConfig
from code_signer.config import FilePathsConfig, PoliciesConfig, OutputConfig

# 创建配置实例
CONFIG = SigningConfig()

# 基本配置
CONFIG.enabled = True
CONFIG.default_certificate = "pdf_rename_operation"
CONFIG.timestamp_server = "http://timestamp.digicert.com"
CONFIG.hash_algorithm = "sha256"

# 证书配置
pdf_cert = CertificateConfig(
    name="pdf_rename_operation",
    sha1="144ac4069565211ab67d25a9d6d33af0e18e511e",
    subject="CN=PDF_Rename_Operation, OU=PS:Softlines, O=TÜV SÜD Certification and Testing (China) Co. Ltd. Xiamen Branch, L=Xiamen, C=CN",
    issuer="CN=TUVSUD-IssuingCA, O=TUVSUD, C=SG",
    valid_from="2025-10-15",
    valid_to="2027-10-15",
    description="TUVSUD颁发的PDF重命名工具专用证书"
)

CONFIG.add_certificate(pdf_cert)
```

### 方式2：JSON配置文件 (兼容)

**配置文件位置**: `signature_config.json`

```json
{
  "signature": {
    "enabled": true,
    "default_certificate": "pdf_rename_operation",
    "timestamp_server": "http://timestamp.digicert.com",
    "hash_algorithm": "sha256",
    "certificates": {
      "pdf_rename_operation": {
        "name": "PDF_Rename_Operation证书",
        "sha1": "144ac4069565211ab67d25a9d6d33af0e18e511e",
        "subject": "CN=PDF_Rename_Operation...",
        "issuer": "CN=TUVSUD-IssuingCA...",
        "valid_from": "2025-10-15",
        "valid_to": "2027-10-15"
      }
    }
  }
}
```

## 证书信息

### 项目专用证书
- **证书名称**: PDF_Rename_Operation
- **颁发机构**: TUVSUD-IssuingCA
- **SHA1哈希**: `144ac4069565211ab67d25a9d6d33af0e18e511e`
- **有效期**: 2025/10/15 - 2027/10/15
- **密钥状态**: 私钥不可导出

### 证书验证
系统会自动验证证书的：
- ✅ 证书是否存在
- ✅ 证书是否有效
- ✅ 证书是否匹配配置

## 使用方法

### 一键签名（推荐）

```bash
python PDF签名工具.py
```

**自动流程**：
1. 智能加载最佳配置
2. 查找可用的签名工具
3. 验证证书和配置
4. 批量签名目标文件
5. 生成签名记录

### 编程方式使用

#### 使用新的配置系统 (推荐)

```python
from code_signer.config_loader import load_signing_config
from code_signer import CodeSigner

# 加载配置
config = load_signing_config()

# 创建签名器
signer = CodeSigner(config)

# 签名文件
success, message = signer.sign_file("app.exe", "pdf_rename_operation")
print(f"签名结果: {success}, {message}")
```

#### 使用传统方式 (兼容)

```python
from signing_tool import SigningTool

# 创建签名工具 (自动加载配置)
tool = SigningTool()

# 签名文件
success, message = tool.sign_file("app.exe")
print(f"签名结果: {success}, {message}")
```

## 签名工具配置

### 自动工具检测
系统会按优先级自动选择可用的签名工具：

1. **signtool.exe** - Windows SDK (优先级1)
   - 路径: 自动查找Windows SDK安装目录
   - 优点: 官方工具，兼容性最好
   - 适用: Windows环境首选

2. **PowerShell** - 内置工具 (优先级2)
   - 路径: 系统内置
   - 优点: 无需额外安装
   - 适用: signtool不可用时的备选

3. **osslsigncode** - 开源工具 (优先级3)
   - 路径: 需要单独安装
   - 优点: 跨平台支持
   - 适用: Linux/macOS环境

### 工具配置示例

```python
# 在Python配置文件中自定义工具
signtool_config = ToolConfig(
    name="signtool",
    enabled=True,
    path="C:\\Custom\\Path\\signtool.exe",  # 自定义路径
    priority=1,
    description="自定义signtool路径"
)

CONFIG.add_tool(signtool_config)
```

## 策略配置

### 签名策略
```python
CONFIG.policies = PoliciesConfig(
    verify_before_sign=True,      # 签名前验证文件是否已签名
    backup_before_sign=False,     # 签名前备份文件
    auto_retry=True,              # 失败时自动重试
    max_retries=3,                # 最大重试次数
    record_signing_history=True   # 记录签名历史
)
```

### 文件路径配置
```python
CONFIG.file_paths = FilePathsConfig(
    search_patterns=[
        "dist/*.exe",           # PyInstaller输出
        "*.exe",                # 当前目录
        "build/*.exe"           # 构建目录
    ],
    exclude_patterns=[
        "*.tmp.exe",           # 临时文件
        "*_unsigned.exe",      # 未签名文件
        "*_backup*.exe"        # 备份文件
    ],
    record_directory="./signature_records"
)
```

## 故障排除

### 常见问题及解决方案

#### 1. 配置加载失败
**错误**: `[错误] 初始化签名工具失败: 证书SHA1不能为空`

**解决方案**:
```python
# 检查配置文件中的证书配置
cert = CertificateConfig(
    name="my_cert",
    sha1="your_certificate_sha1_here",  # 确保SHA1不为空
    subject="CN=Your App",
    issuer="CN=CA"
)
```

#### 2. 找不到签名工具
**错误**: `[错误] 未找到signtool.exe`

**解决方案**:
- 安装Windows 10 SDK
- 或在配置中指定工具路径
- 系统会自动降级到PowerShell

#### 3. 证书不可用
**错误**: `[错误] 证书验证失败`

**解决方案**:
```python
# 检查证书是否在系统中存在
# 运行以下命令查看证书：
certutil -store MY
```

#### 4. 配置验证失败
**错误**: 配置验证发现问题

**解决方案**:
```python
# 使用配置验证工具
from code_signer.examples.project_config import validate_config
validate_config()  # 会显示所有配置问题
```

### 调试模式

启用调试模式查看详细信息：
```python
import os
os.environ['DEBUG_ENCODING'] = '1'  # 显示编码调试信息
```

### 配置验证工具

运行配置验证：
```bash
python test_signing_config.py
```

## 最佳实践

### 1. 配置管理
- 使用Python配置文件获得类型安全
- 定期验证配置完整性
- 备份重要配置文件

### 2. 证书管理
- 定期检查证书有效期
- 在证书到期前及时更新
- 安全保管证书私钥

### 3. 签名流程
- 签名前验证文件完整性
- 保留签名记录和日志
- 定期测试签名功能

### 4. 错误处理
- 实现适当的错误重试机制
- 记录详细的错误日志
- 提供用户友好的错误信息

## 迁移指南

### 从旧配置迁移到新配置

**步骤1**: 备份现有配置
```bash
cp signature_config.json signature_config.json.backup
```

**步骤2**: 使用迁移工具 (如果需要)
```python
from code_signer.config_loader import load_signing_config
config = load_signing_config("signature_config.json")  # 加载旧配置
# 配置会自动转换为新格式
```

**步骤3**: 验证新配置
```bash
python test_signing_config.py
```

**步骤4**: 更新代码使用新API
```python
# 旧方式
from signing_tool import SigningTool
tool = SigningTool("signature_config.json")

# 新方式 (推荐)
from code_signer.config_loader import load_signing_config
config = load_signing_config()
```

## 技术支持

如遇到问题，请按以下步骤排查：

1. **运行诊断工具**:
   ```bash
   python test_signing_config.py
   python test_actual_signing.py
   ```

2. **检查日志文件**:
   - `./signature_records/` 目录下的签名记录
   - 控制台输出的详细错误信息

3. **验证环境**:
   - Python 3.7+
   - Windows SDK (如使用signtool)
   - 有效的代码签名证书

4. **获取帮助**:
   - 查看本文档的故障排除章节
   - 检查 `code_signer/README.md` 获取详细API文档
   - 运行测试工具验证环境配置