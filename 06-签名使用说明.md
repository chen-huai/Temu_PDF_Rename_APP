# PDF重命名工具 - 数字签名使用说明

## 架构概述

本项目采用**通用签名模块 + 项目专用配置**的架构：

- **通用模块**: `signing_tool.py` - 可复用的代码签名核心
- **配置文件**: `signature_config.json` - 统一的签名配置管理
- **项目入口**: `PDF签名工具.py` - 项目专用的签名界面

## 配置文件说明

### signature_config.json 结构

```json
{
  "signature": {
    "enabled": true,
    "default_certificate": "pdf_rename_operation",
    "timestamp_server": "http://timestamp.digicert.com",
    "certificates": {
      "pdf_rename_operation": {
        "name": "PDF_Rename_Operation证书",
        "sha1": "144ac4069565211ab67d25a9d6d33af0e18e511e",
        "subject": "CN=PDF_Rename_Operation...",
        "issuer": "CN=TUVSUD-IssuingCA..."
      }
    },
    "signing_tools": { ... },
    "policies": { ... }
  }
}
```

## PDF重命名工具证书信息

- **证书名称**: PDF_Rename_Operation
- **颁发机构**: TUVSUD-IssuingCA
- **SHA1哈希**: `144ac4069565211ab67d25a9d6d33af0e18e511e`
- **有效期**: 2025/10/15 - 2027/10/15
- **密钥状态**: 私钥不可导出

## 使用方法

### 一键签名（推荐）

```bash
python PDF签名工具.py
```

**功能特点：**
- ✅ 基于通用签名模块，配置驱动
- ✅ 自动验证PDF_Rename_Operation证书
- ✅ 自动查找PDF_Rename_Operation.exe文件
- ✅ 一键签名，无需配置
- ✅ 自动验证签名结果
- ✅ 生成详细签名记录

## 通用签名模块使用

### 基本用法

```python
from signing_tool import SigningTool

# 初始化签名工具
tool = SigningTool("signature_config.json")

# 签名文件
success, message = tool.sign_file("app.exe", "certificate_name")

# 验证签名
success, message = tool.verify_signature("app.exe")
```

### 便捷函数

```python
from signing_tool import sign_file, verify_file_signature

# 快速签名
success, message = sign_file("app.exe")

# 快速验证
success, message = verify_file_signature("app.exe")
```

### 批量签名

```python
# 批量签名目录中的所有exe文件
results = tool.batch_sign("dist/", "certificate_name")
for file_path, (success, message) in results.items():
    print(f"{file_path}: {message}")
```

## 工作流程

1. **证书验证**: 检查PDF_Rename_Operation证书是否在系统中，代码```certutil -user -store My```
2. **文件查找**: 自动查找需要签名的exe文件
3. **签名操作**: 使用TUVSUD证书进行签名
4. **结果验证**: 验证签名是否成功
5. **记录保存**: 生成签名记录文件

## 预期文件路径

工具会自动查找以下位置的exe文件：
- `dist/PDF_Rename_Operation.exe`
- `PDF重命名工具_便携版/PDF_Rename_Operation.exe`
- `PDF_Rename_Operation.exe`

## 验证签名

### 方法1：文件属性
1. 右键点击exe文件
2. 选择"属性"
3. 查看"数字签名"选项卡
4. 确认显示TUVSUD证书信息

### 方法2：命令行验证
```cmd
signtool verify /pa "dist/PDF_Rename_Operation.exe"
```

## 故障排除

### 问题：未找到PDF_Rename_Operation证书
**解决方案：**
确保证书已安装到当前用户的个人证书存储中

### 问题：未找到signtool.exe
**解决方案：**
安装Windows SDK，选择"Windows SDK Signing Tools"

### 问题：签名失败
**解决方案：**
1. 检查网络连接（时间戳服务器）
2. 确保证书权限正确
3. 确认文件未被占用

## 签名记录

签名成功后，会生成 `*_签名记录.json` 文件，包含：
- 签名文件路径
- 证书详细信息
- 签名时间
- 签名状态
- 工具版本

## 项目复用指南

### 复制到其他项目

1. **复制核心文件**：
   ```
   your_project/
   ├── signing_tool.py           # 通用签名模块
   └── signature_config.json      # 签名配置文件
   ```

2. **修改配置文件**：
   ```json
   {
     "signature": {
       "default_certificate": "your_certificate",
       "certificates": {
         "your_certificate": {
           "name": "您的证书名称",
           "sha1": "您的证书SHA1哈希",
           "subject": "证书主体信息",
           "issuer": "证书颁发者信息"
         }
       }
     }
   }
   ```

3. **使用通用模块**：
   ```python
   from signing_tool import SigningTool

   tool = SigningTool("signature_config.json")
   success, message = tool.sign_file("your_app.exe", "your_certificate")
   ```

### 支持的签名工具

- **signtool.exe** (Windows SDK) - 优先级1
- **PowerShell Set-AuthenticodeSignature** - 优先级2
- **osslsigncode** - 优先级3

### 高级配置

```json
{
  "signature": {
    "policies": {
      "verify_before_sign": true,      // 签名前验证证书
      "backup_before_sign": false,     // 签名前备份文件
      "auto_retry": true,               // 自动重试
      "max_retries": 3,                 // 最大重试次数
      "record_signing_history": true    // 记录签名历史
    },
    "file_paths": {
      "search_patterns": ["*.exe", "build/*.exe"],
      "exclude_patterns": ["*.tmp.exe", "*_unsigned.exe"],
      "record_directory": "./signature_records"
    },
    "output": {
      "verbose": true,                 // 详细输出
      "save_records": true,             // 保存记录
      "create_log_file": true          // 创建日志文件
    }
  }
}
```

## 推荐使用流程

1. **生成exe文件**: 运行打包工具
2. **一键签名**: 运行 `python PDF签名工具.py`
3. **验证结果**: 检查exe文件属性

## 更新日志

### v2.0 (2025-10-27)
- ✨ 重构为通用签名模块架构
- ✨ 支持配置驱动的多证书管理
- ✨ 增强的签名策略和批量处理
- ✨ 完整的项目复用支持

### v1.0 (2025-10-16)
- 🎯 初始版本，支持PDF_Rename_Operation证书签名

---

**版本**: 2.0
**更新时间**: 2025-10-27
**架构**: 通用签名模块 + 配置驱动
**适用证书**: 支持多种代码签名证书