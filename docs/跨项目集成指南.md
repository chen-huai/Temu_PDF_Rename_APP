# 跨项目集成指南

## 概述

本指南详细介绍如何将更新模块集成到新的项目中。更新模块采用高度模块化设计，支持快速集成到不同类型的桌面应用程序中。

## 集成前准备

### 系统要求
- Python 3.7+
- PyQt5 (如果使用GUI界面)
- 网络连接 (用于检查更新)
- GitHub仓库 (用于托管更新文件)

### 依赖包
```txt
PyQt5>=5.15.0
requests>=2.25.0
```

## 快速集成步骤

### 步骤1：复制更新模块
```bash
# 复制整个更新模块到新项目
cp -r /path/to/old_project/auto_updater /path/to/new_project/
```

### 步骤2：配置项目信息
```bash
# 复制配置模板
cp /path/to/old_project/updater_config.json.template /path/to/new_project/updater_config.json

# 编辑配置文件
nano /path/to/new_project/updater_config.json
```

**配置修改**：
```json
{
  "app": {
    "name": "你的应用名称",
    "executable": "YourApp.exe"
  },
  "repository": {
    "owner": "your-username",
    "repo": "your-repo"
  },
  "version": {
    "current": "1.0.0"
  }
}
```

### 步骤3：集成到主程序
```python
# 在主程序中添加更新功能
import sys
sys.path.append('auto_updater')

from auto_updater import AutoUpdater

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # ... 其他初始化代码 ...

        # 初始化更新器
        self.auto_updater = None
        try:
            self.auto_updater = AutoUpdater(self)
            logger.info("自动更新器初始化成功")
        except Exception as e:
            logger.error(f"自动更新器初始化失败: {e}")
            self.auto_updater = None
```

### 步骤4：添加更新菜单
```python
def setup_ui(self):
    # 创建菜单栏
    menubar = self.menuBar()

    # 帮助菜单
    help_menu = menubar.addMenu("帮助(&H)")

    # 检查更新
    update_action = QAction("检查更新(&U)", self)
    update_action.triggered.connect(self.check_for_updates)
    help_menu.addAction(update_action)

    # 关于
    about_action = QAction("关于(&A)", self)
    about_action.triggered.connect(self.show_about)
    help_menu.addAction(about_action)

def check_for_updates(self):
    """检查更新"""
    if not self.auto_updater:
        QMessageBox.warning(self, "更新功能不可用", "自动更新功能未正确初始化")
        return

    try:
        has_update, remote_version, local_version, error = self.auto_updater.check_for_updates()

        if error:
            QMessageBox.warning(self, "检查更新失败", f"检查更新时发生错误：\n{error}")
            return

        if has_update:
            reply = QMessageBox.question(
                self,
                "发现新版本",
                f"发现新版本 {remote_version}！\n当前版本: {local_version}\n\n是否立即下载更新？",
                QMessageBox.Yes | QMessageBox.No
            )
            if reply == QMessageBox.Yes:
                self.start_update_process()
        else:
            QMessageBox.information(self, "检查更新", "您的软件已是最新版本！")

    except Exception as e:
        logger.error(f"检查更新异常: {e}")
        QMessageBox.critical(self, "错误", f"检查更新时发生异常：\n{str(e)}")
```

## 详细集成流程

### 1. 项目结构规划
```
your-project/
├── main.py                      # 主程序入口
├── auto_updater/                # 更新模块（复制）
│   ├── __init__.py
│   ├── version_manager.py
│   ├── github_client.py
│   ├── download_manager.py
│   ├── backup_manager.py
│   ├── update_executor.py
│   ├── config.py
│   ├── error_handler.py
│   └── settings.py
├── updater_config.json          # 项目配置
├── resources/                    # 资源文件
│   └── icon.png
└── requirements.txt             # 依赖包
```

### 2. GitHub仓库设置
#### 创建Release仓库
```bash
# 创建专门用于更新的仓库
git clone https://github.com/your-username/your-app-updates.git
cd your-app-updates

# 创建Release
gh release create v1.0.0 \
  --title "版本1.0.0发布" \
  --notes "第一个发布版本" \
  YourApp-1.0.0.exe
```

#### Release文件命名规范
- 使用语义化版本号
- 包含完整的应用程序名称
- 示例：`MyApp-1.0.0.exe`, `MyApp-1.1.0.exe`

### 3. 配置文件详解
```json
{
  "app": {
    "name": "我的应用程序",
    "executable": "MyApp.exe",
    "version_file": "version.txt"
  },
  "repository": {
    "owner": "mycompany",
    "repo": "myapp-updates",
    "api_base": "https://api.github.com"
  },
  "version": {
    "current": "1.0.0",
    "check_interval_days": 7,
    "auto_check_enabled": true
  },
  "update": {
    "backup_count": 3,
    "download_timeout": 300,
    "max_retries": 3,
    "auto_restart": true
  },
  "network": {
    "request_headers": {
      "Accept": "application/vnd.github.v3+json",
      "User-Agent": "MyApp-Updater/1.0.0"
    }
  }
}
```

### 4. 进度显示集成
```python
class UpdateProgressDialog(QDialog):
    """更新进度对话框"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("正在更新")
        self.setFixedSize(400, 150)
        self.setModal(True)
        self.update_thread = None
        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout()

        # 状态标签
        self.status_label = QLabel("准备更新...")
        self.status_label.setAlignment(Qt.AlignCenter)

        # 进度条
        self.progress_bar = QProgressBar()
        self.progress_bar.setRange(0, 100)
        self.progress_bar.setValue(0)

        layout.addWidget(self.status_label)
        layout.addWidget(self.progress_bar)
        self.setLayout(layout)

    def start_update(self, version, auto_updater):
        """开始更新"""
        self.status_label.setText(f"正在更新到版本 {version}...")
        self.progress_bar.setValue(0)

        # 创建并启动更新线程
        self.update_thread = UpdateThread(auto_updater, version)
        self.update_thread.progress_signal.connect(self.update_progress)
        self.update_thread.status_signal.connect(self.update_status)
        self.update_thread.finished_signal.connect(self.update_finished)
        self.update_thread.start()

    def update_progress(self, downloaded, total, percentage):
        """更新进度"""
        if percentage >= 0:
            self.progress_bar.setValue(percentage)
        else:
            self.progress_bar.setRange(0, 0)
            self.status_label.setText(f"等待重试，{-percentage}秒后重试...")

    def update_status(self, status):
        """更新状态"""
        self.status_label.setText(status)

    def update_finished(self, success, error):
        """更新完成"""
        if success:
            self.status_label.setText("更新完成！应用程序将重启...")
            self.progress_bar.setValue(100)
            QTimer.singleShot(2000, self.restart_application)
        else:
            self.status_label.setText(f"更新失败: {error}")
            self.progress_bar.setValue(0)
            QMessageBox.critical(self, "更新失败", f"更新失败：\n{error}")
```

### 5. 线程安全更新
```python
class UpdateThread(QThread):
    """更新线程"""
    progress_signal = pyqtSignal(int, int, int)
    status_signal = pyqtSignal(str)
    finished_signal = pyqtSignal(bool, str)

    def __init__(self, auto_updater, version):
        super().__init__()
        self.auto_updater = auto_updater
        self.version = version

    def run(self):
        """执行更新过程"""
        try:
            self.status_signal.emit("正在下载更新文件...")

            # 下载更新文件
            success, download_path, error = self.auto_updater.download_update(
                self.version, self.progress_callback
            )

            if not success:
                self.finished_signal.emit(False, f"下载失败: {error}")
                return

            self.status_signal.emit("正在安装更新...")

            # 执行更新
            success, error = self.auto_updater.execute_update(download_path)

            if success:
                self.finished_signal.emit(True, None)
            else:
                self.finished_signal.emit(False, f"安装失败: {error}")

        except Exception as e:
            self.finished_signal.emit(False, f"更新过程异常: {str(e)}")

    def progress_callback(self, downloaded, total, percentage):
        """进度回调"""
        self.progress_signal.emit(downloaded, total, percentage)
```

## 测试验证

### 1. 功能测试
```python
def test_update_integration():
    """测试更新功能集成"""
    try:
        # 初始化更新器
        updater = AutoUpdater()

        # 测试配置读取
        assert updater.version_manager.get_version() == "1.0.0"

        # 测试版本检查
        has_update, remote_version, local_version, error = updater.check_for_updates()
        assert error is None

        print("✅ 更新功能集成测试通过")

    except Exception as e:
        print(f"❌ 更新功能集成测试失败: {e}")
        return False

    return True
```

### 2. 界面测试
```python
def test_ui_integration():
    """测试界面集成"""
    app = QApplication(sys.argv)
    window = MainWindow()

    # 测试菜单项
    update_action = None
    for action in window.menuBar().actions():
        if action.text() == "帮助(&H)":
            for sub_action in action.menu().actions():
                if "更新" in sub_action.text():
                    update_action = sub_action
                    break

    assert update_action is not None, "更新菜单项未找到"
    print("✅ 界面集成测试通过")

    return True
```

## 常见集成问题

### 1. 路径问题
**问题**：配置文件路径不正确
**解决方案**：
```python
import os
import sys

def get_project_root():
    """获取项目根目录"""
    if getattr(sys, 'frozen', False):
        return os.path.dirname(sys.executable)
    else:
        return os.path.dirname(os.path.abspath(__file__))

config_path = os.path.join(get_project_root(), "updater_config.json")
```

### 2. 依赖冲突
**问题**：包版本冲突
**解决方案**：
```txt
# requirements.txt
PyQt5>=5.15.0,<6.0.0
requests>=2.25.0,<3.0.0
```

### 3. 网络问题
**问题**：GitHub API访问受限
**解决方案**：
```json
{
  "network": {
    "request_headers": {
      "Authorization": "token YOUR_GITHUB_TOKEN",
      "User-Agent": "MyApp-Updater/1.0.0"
    }
  }
}
```

### 4. 权限问题
**问题**：文件写入权限不足
**解决方案**：
```python
def check_write_permissions():
    """检查写入权限"""
    import tempfile

    try:
        with tempfile.NamedTemporaryFile(delete=True) as tmp:
            tmp.write(b"test")
        return True
    except PermissionError:
        return False

if not check_write_permissions():
    QMessageBox.warning(None, "权限警告", "应用程序没有足够的权限执行更新操作")
```

## 部署检查清单

### 集成完成后检查
- [ ] 更新模块文件已复制
- [ ] 配置文件已创建并正确配置
- [ ] 主程序已集成更新功能
- [ ] 菜单项已添加并连接
- [ ] 进度对话框已实现
- [ ] 错误处理已完善
- [ ] 日志记录已配置

### 功能验证
- [ ] 版本检查功能正常
- [ ] 下载功能正常
- [ ] 备份功能正常
- [ ] 更新执行功能正常
- [ ] 重启功能正常
- [ ] 错误处理正常

### 发布前检查
- [ ] GitHub Release已创建
- [ ] 配置文件版本号正确
- [ ] 应用程序文件名正确
- [ ] 测试环境验证通过
- [ ] 用户文档已更新

## 维护建议

### 1. 版本管理
- 使用语义化版本号
- 及时更新配置文件中的版本号
- 保持Release描述的一致性

### 2. 配置管理
- 定期检查配置文件
- 根据项目变化调整配置
- 保持配置文件的备份

### 3. 监控日志
- 监控更新成功率
- 分析失败原因
- 优化更新策略

## 总结

通过本指南，您可以在5分钟内将更新模块集成到新的项目中。更新模块的模块化设计和配置驱动架构，使得跨项目集成变得简单高效。关键步骤包括：

1. **复制模块文件**
2. **配置项目信息**
3. **集成主程序**
4. **添加界面元素**
5. **测试验证功能**

正确的集成将为您的应用程序提供专业级的自动更新功能，大大提升用户体验和维护效率。