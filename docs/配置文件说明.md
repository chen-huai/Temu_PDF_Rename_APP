# 配置文件说明

## 概述

`updater_config.json` 是更新模块的核心配置文件，采用JSON格式，包含所有项目特定的配置信息。通过修改此文件，可以轻松适配不同的项目和部署环境。

## 配置文件结构

### 完整配置示例

```json
{
  "app": {
    "name": "PDF重命名工具",
    "executable": "PDF_Rename_Operation.exe",
    "version_file": "version.txt"
  },
  "repository": {
    "owner": "chen-huai",
    "repo": "Temu_PDF_Rename_APP",
    "api_base": "https://api.github.com"
  },
  "version": {
    "current": "2.0.0",
    "check_interval_days": 30,
    "auto_check_enabled": true
  },
  "update": {
    "backup_count": 3,
    "download_timeout": 300,
    "max_retries": 3,
    "auto_restart": true
  },
  "network": {
    "request_headers": {
      "Accept": "application/vnd.github.v3+json",
      "User-Agent": "PDF-Rename-Tool-Updater/1.0"
    }
  }
}
```

## 配置项详解

### 1. 应用配置 (app)

| 配置项 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `name` | string | 可选 | "默认应用" | 应用显示名称，用于UI界面 |
| `executable` | string | 必需 | "your_app.exe" | 可执行文件名 |
| `version_file` | string | 可选 | "version.txt" | 版本文件名（向后兼容） |

**示例**：
```json
{
  "app": {
    "name": "我的应用程序",
    "executable": "MyApp.exe",
    "version_file": "version.txt"
  }
}
```

### 2. 仓库配置 (repository)

| 配置项 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `owner` | string | 必需 | "your-username" | GitHub用户名或组织名 |
| `repo` | string | 必需 | "your-repo" | GitHub仓库名 |
| `api_base` | string | 可选 | "https://api.github.com" | GitHub API基础URL |

**示例**：
```json
{
  "repository": {
    "owner": "mycompany",
    "repo": "myapp-updates",
    "api_base": "https://api.github.com"
  }
}
```

### 3. 版本配置 (version)

| 配置项 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `current` | string | 必需 | "1.0.0" | 当前版本号 |
| `check_interval_days` | integer | 可选 | 30 | 自动检查间隔天数 |
| `auto_check_enabled` | boolean | 可选 | true | 是否启用自动检查 |

**版本号格式**：
- 推荐使用语义化版本：`主版本.次版本.修订版本`
- 示例：`1.0.0`, `2.1.3`, `10.0.5`

**示例**：
```json
{
  "version": {
    "current": "2.1.0",
    "check_interval_days": 7,
    "auto_check_enabled": true
  }
}
```

### 4. 更新配置 (update)

| 配置项 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `backup_count` | integer | 可选 | 3 | 最大备份数量 |
| `download_timeout` | integer | 可选 | 300 | 下载超时时间（秒） |
| `max_retries` | integer | 可选 | 3 | 最大重试次数 |
| `auto_restart` | boolean | 可选 | true | 更新后自动重启 |

**示例**：
```json
{
  "update": {
    "backup_count": 5,
    "download_timeout": 600,
    "max_retries": 5,
    "auto_restart": true
  }
}
```

### 5. 网络配置 (network)

| 配置项 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `request_headers` | object | 可选 | 见下方 | HTTP请求头配置 |

**默认请求头**：
```json
{
  "Accept": "application/vnd.github.v3+json",
  "User-Agent": "App-Updater/1.0"
}
```

**自定义请求头示例**：
```json
{
  "network": {
    "request_headers": {
      "Accept": "application/vnd.github.v3+json",
      "User-Agent": "MyApp-Updater/2.0.0",
      "Authorization": "token YOUR_GITHUB_TOKEN"
    }
  }
}
```

## 配置文件位置

### 开发环境
```
project-root/
├── updater_config.json          # 开发环境配置
├── auto_updater/
└── ...
```

### 生产环境（打包后）
```
app-directory/
├── MyApp.exe                   # 应用程序
├── updater_config.json          # 生产环境配置
├── backup/                      # 备份目录
└── ...
```

## 配置验证

### 必需配置项
以下配置项是更新功能正常工作的必需项：

1. `app.executable` - 应用程序文件名
2. `repository.owner` - GitHub用户名
3. `repository.repo` - GitHub仓库名
4. `version.current` - 当前版本号

### 配置验证函数
```python
def validate_config(config_path: str) -> tuple:
    """验证配置文件"""
    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            config = json.load(f)

        # 检查必需项
        required_keys = [
            'app.executable',
            'repository.owner',
            'repository.repo',
            'version.current'
        ]

        for key in required_keys:
            parts = key.split('.')
            value = config
            for part in parts:
                if part not in value:
                    return False, f"缺少必需配置项: {key}"
                value = value[part]

        # 验证版本号格式
        version = config.get('version', {}).get('current', '')
        if not re.match(r'^\d+\.\d+(\.\d+)?$', version):
            return False, f"无效的版本号格式: {version}"

        return True, "配置验证通过"

    except json.JSONDecodeError as e:
        return False, f"JSON格式错误: {e}"
    except Exception as e:
        return False, f"验证失败: {e}"
```

## 配置最佳实践

### 1. 版本号管理
```json
{
  "version": {
    "current": "1.0.0"
  }
}
```

**版本号更新规则**：
- **主版本**：不兼容的API修改
- **次版本**：向下兼容的功能性新增
- **修订版本**：向下兼容的问题修正

### 2. 仓库配置
```json
{
  "repository": {
    "owner": "myorganization",
    "repo": "myapp-releases"
  }
}
```

**注意事项**：
- 仓库应该是公开的，或配置访问令牌
- 建议使用专门的releases仓库
- 确保Release Assets包含可执行文件

### 3. 网络配置
```json
{
  "network": {
    "request_headers": {
      "User-Agent": "MyApp-Updater/1.0.0"
    }
  }
}
```

**User-Agent格式**：
`应用名称-Updater/版本号`

### 4. 更新策略
```json
{
  "update": {
    "check_interval_days": 7,
    "backup_count": 5,
    "auto_restart": true
  }
}
```

**推荐设置**：
- `check_interval_days`: 7-30天
- `backup_count`: 3-5个
- `download_timeout`: 300-600秒

## 环境特定配置

### 开发环境配置
```json
{
  "app": {
    "name": "我的应用(开发版)",
    "executable": "MyApp-dev.exe"
  },
  "repository": {
    "owner": "dev-team",
    "repo": "myapp-dev"
  },
  "version": {
    "current": "0.9.0"
  },
  "update": {
    "auto_check_enabled": false
  }
}
```

### 生产环境配置
```json
{
  "app": {
    "name": "我的应用",
    "executable": "MyApp.exe"
  },
  "repository": {
    "owner": "mycompany",
    "repo": "myapp-releases"
  },
  "version": {
    "current": "1.0.0"
  },
  "update": {
    "auto_check_enabled": true,
    "check_interval_days": 30
  }
}
```

### 测试环境配置
```json
{
  "app": {
    "name": "我的应用(测试版)",
    "executable": "MyApp-test.exe"
  },
  "repository": {
    "owner": "test-team",
    "repo": "myapp-test"
  },
  "version": {
    "current": "1.0.0-beta"
  },
  "update": {
    "auto_check_enabled": true,
    "check_interval_days": 1
  }
}
```

## 常见配置问题

### 1. GitHub API限制
**问题**：API调用频率过高
**解决方案**：
```json
{
  "network": {
    "request_headers": {
      "Authorization": "token YOUR_GITHUB_TOKEN"
    }
  }
}
```

### 2. 下载超时
**问题**：大文件下载超时
**解决方案**：
```json
{
  "update": {
    "download_timeout": 600
  }
}
```

### 3. 备份空间不足
**问题**：备份文件占用过多空间
**解决方案**：
```json
{
  "update": {
    "backup_count": 2
  }
}
```

## 配置模板使用

### 1. 复制模板文件
```bash
cp updater_config.json.template updater_config.json
```

### 2. 修改关键配置
```json
{
  "app": {
    "name": "你的应用名称",
    "executable": "YourApp.exe"
  },
  "repository": {
    "owner": "your-username",
    "repo": "your-repo"
  },
  "version": {
    "current": "1.0.0"
  }
}
```

### 3. 验证配置
```python
from auto_updater.config import get_config

try:
    config = get_config()
    print(f"配置加载成功: {config.app_name}")
    print(f"版本: {config.current_version}")
    print(f"仓库: {config.github_repo}")
except Exception as e:
    print(f"配置加载失败: {e}")
```

## 总结

`updater_config.json` 是更新模块配置的核心，通过合理的配置管理，可以实现：

- **项目适配**：不同项目使用不同配置
- **环境隔离**：开发、测试、生产环境分离
- **灵活定制**：根据需要调整更新策略
- **维护简化**：集中管理所有配置项

正确配置此文件是更新功能正常工作的关键。建议在项目初期就仔细规划配置策略，并在部署前进行充分的测试验证。