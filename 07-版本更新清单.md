# 版本更新操作清单 (Config类统一版本管理)

## 🎯 架构重构说明

**问题**: 版本号分散在多个文件中（version.txt、update_config.json等），更新时需要手动同步多个地方，违反了DRY原则。

**解决方案**: 采用Config类统一版本管理架构，实现配置文件驱动的版本控制（Single Source of Truth）。

### 🔄 重构内容

- [x] `auto_updater/config.py` - 集成版本管理功能到Config类
- [x] `auto_updater/__init__.py` - 移除version_manager依赖，使用Config类
- [x] `updater_config.json` - 唯一版本数据源（version.current字段）
- [x] `update_state.json` - 新增状态管理文件，替换update_config.json
- [x] 删除 `version_manager.py` - 功能已合并到Config类
- [x] 删除 `version.txt` - 版本信息直接存储在配置文件中

## 🚀 版本更新方法

### 方法1: 使用Config类API（推荐）

```python
from auto_updater.config import get_config

# 获取配置实例
config = get_config()

# 更新版本号（自动保存到配置文件）
success = config.update_current_version("2.1.0")

# 验证版本一致性
current_version = config.current_version
is_newer = config.is_newer_version("v2.2.0", current_version)
```

### 方法2: 直接修改配置文件

编辑 `updater_config.json`:
```json
{
  "version": {
    "current": "2.1.0",  // 修改这里
    "check_interval_days": 30,
    "auto_check_enabled": true
  }
}
```

### 方法3: 使用Python脚本（可创建工具脚本）

```python
# update_version.py
from auto_updater.config import get_config
import sys

def update_version(new_version):
    config = get_config()
    if config.update_current_version(new_version):
        print(f"版本已更新到: {new_version}")
        return True
    else:
        print("版本更新失败")
        return False

if __name__ == "__main__":
    if len(sys.argv) == 2:
        update_version(sys.argv[1])
    else:
        print("用法: python update_version.py x.x.x")
```

## 📋 Config类版本管理功能

### 核心方法

```python
from auto_updater.config import get_config

config = get_config()

# 获取当前版本
version = config.current_version  # "2.0.0"

# 更新版本
success = config.update_current_version("2.1.0")

# 版本比较
result = config.compare_versions("2.0.0", "2.1.0")  # -1
is_newer = config.is_newer_version("v2.1.0", "2.0.0")  # True

# 更新检查时间管理
config.update_last_check_time()
should_check = config.should_check_for_updates()

# 获取GitHub信息
github_url = config.github_latest_release_url
```

### 自动状态管理

- **版本状态**: 存储在 `updater_config.json` 的 `version.current` 字段
- **更新检查状态**: 存储在 `update_state.json` 文件中
- **自动同步**: 版本更新时自动保存到配置文件
- **验证机制**: 内置版本号格式验证和比较逻辑

## ✅ 配置文件结构

### `updater_config.json` (主配置文件)

```json
{
  "app": {
    "name": "PDF重命名工具",
    "executable": "PDF_Rename_Operation.exe"
  },
  "repository": {
    "owner": "chen-huai",
    "repo": "Temu_PDF_Rename_APP",
    "api_base": "https://api.github.com"
  },
  "version": {
    "current": "2.0.0",              // 【唯一版本数据源】
    "check_interval_days": 30,
    "auto_check_enabled": true
  },
  "update": {
    "backup_count": 3,
    "download_timeout": 300,
    "max_retries": 3,
    "auto_restart": true
  },
  "network": {
    "request_headers": {
      "Accept": "application/vnd.github.v3+json",
      "User-Agent": "App-Updater/1.0"
    }
  }
}
```

### `update_state.json` (状态文件)

```json
{
  "last_check_date": "2025-10-27T10:30:00",
  "last_download_version": "2.0.0",
  "update_history": [
    {
      "date": "2025-10-27T10:30:00",
      "from_version": "1.9.0",
      "to_version": "2.0.0",
      "success": true
    }
  ]
}
```

## 📋 更新验证清单

### 自动验证
```python
from auto_updater.config import get_config

config = get_config()

# 验证版本格式
print(f"当前版本: {config.current_version}")

# 验证GitHub连接
print(f"GitHub URL: {config.github_latest_release_url}")

# 验证配置完整性
print(f"检查间隔: {config.update_check_interval_days}天")
```

### 手动验证
- [ ] `updater_config.json` 中的版本号正确
- [ ] Config类能正确读取版本号
- [ ] 版本比较功能正常工作
- [ ] 更新检查状态管理正常
- [ ] GitHub API连接正常

## 🎨 架构优势

### ✅ 遵循设计原则
- **DRY**: 版本号只在配置文件中定义
- **KISS**: 更新版本只需修改一个配置字段
- **单一职责**: Config类专门负责配置和版本管理
- **配置驱动**: 所有功能通过配置文件控制

### ✅ 开发体验
- **零错误**: 避免手动同步导致的版本不一致
- **高效率**: 一处修改，全局生效
- **可验证**: 内置版本一致性检查
- **易维护**: 集中管理所有配置和版本信息

### ✅ 模块独立性
- **自包含**: auto_updater模块完全独立
- **可移植**: 易于复制到其他项目
- **配置化**: 通过配置文件适配不同项目

## ⚠️ 重要注意事项

### 🚫 不要手动修改
- 不要创建独立的version.txt文件
- 不要绕过Config类直接操作版本信息
- 不要在多个地方维护版本号

### ✅ 正确的更新流程
1. 修改 `updater_config.json` 中的 `version.current` 字段
2. 或使用Config类API更新版本
3. 验证版本更新是否生效
4. 测试应用程序功能
5. 提交代码并创建GitHub Release

### 📝 开发者注意
- 版本号格式: `x.y.z`（语义化版本）
- 新功能: 递增次版本号 (y)
- Bug修复: 递增修订版本号 (z)
- 重大变更: 递增主版本号 (x)
- GitHub Release标签格式: `vx.y.z`

## 🔄 Git工作流

```bash
# 1. 更新版本（方法1：直接修改配置）
# 编辑 updater_config.json，修改 version.current

# 或方法2：使用Python脚本
python -c "
from auto_updater.config import get_config
config = get_config()
config.update_current_version('2.1.0')
print('版本已更新')
"

# 2. 验证功能
python PDF_Rename_Operation.py

# 3. 提交更改
git add .
git commit -m "chore: 升级版本到 v2.1.0"

# 4. 创建标签
git tag v2.1.0
git push origin v2.1.0

# 5. 创建GitHub Release并上传新版本
```

## 🔧 集成到应用程序

### 在主程序中使用

```python
from auto_updater.config import get_config

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.config = get_config()
        self.setup_ui()
        self.update_version_display()

    def update_version_display(self):
        # 动态显示版本号
        version_text = f"Version v{self.config.current_version}"
        self.version_label.setText(version_text)
        self.setWindowTitle(f"PDF重命名工具 v{self.config.current_version}")
```

### 在自动更新器中使用

```python
from auto_updater import AutoUpdater
from auto_updater.config import get_config

def check_and_update():
    config = get_config()

    # 检查是否需要更新
    if config.should_check_for_updates():
        updater = AutoUpdater()
        if updater.check_for_updates():
            updater.execute_update()

        # 更新检查时间
        config.update_last_check_time()
```

---

**重构完成**: 2025-10-27
**架构设计**: Config类统一版本管理
**维护成本**: 极低（配置文件驱动）
**错误风险**: 极低（单一数据源）
**模块独立性**: 完全自包含，易于移植