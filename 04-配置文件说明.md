# 配置文件说明

## 概述

项目采用**Python常量配置系统**，所有配置信息直接嵌入到代码中，消除外部文件依赖，提高安全性和部署便利性。

## 🔄 配置系统架构变更

### ✨ 新架构特点（v2.0.0+）

- **Python常量配置**：所有配置信息存储在`auto_updater/config_constants.py`中
- **零外部依赖**：打包后的exe文件无需任何外部配置文件
- **类型安全**：支持IDE自动补全和类型检查
- **用户不可修改**：确保核心配置的安全性

### ❌ 旧架构问题（v2.0.0之前）

- **JSON配置文件**：需要外部文件支持，容易丢失或被修改
- **部署复杂性**：需要确保配置文件与exe在同一目录
- **安全风险**：用户可能误修改关键配置

## 📁 配置文件结构

### 1. config_constants.py（核心配置文件）

**位置**：`auto_updater/config_constants.py`

**用途**：应用程序的核心配置常量，包含所有应用信息、仓库配置、版本管理等。

**主要内容**：
```python
# 应用配置
APP_NAME: str = "PDF重命名工具"
APP_EXECUTABLE: str = "PDF_Rename_Operation.exe"

# GitHub仓库配置
GITHUB_OWNER: str = "chen-huai"
GITHUB_REPO: str = "Temu_PDF_Rename_APP"
GITHUB_API_BASE: str = "https://api.github.com"

# 版本配置
CURRENT_VERSION: str = "2.0.1"
UPDATE_CHECK_INTERVAL_DAYS: int = 30
AUTO_CHECK_ENABLED: bool = True

# 更新配置
MAX_BACKUP_COUNT: int = 3
DOWNLOAD_TIMEOUT: int = 300
MAX_RETRIES: int = 3
AUTO_RESTART: bool = True

# 网络配置
REQUEST_HEADERS: dict = {
    "Accept": "application/vnd.github.v3+json",
    "User-Agent": "PDF-Rename-Tool-Updater/1.0"
}
```

**关键优势**：
- **编译时嵌入**：配置信息直接编译到exe文件中
- **类型安全**：Python类型提示确保配置正确性
- **IDE支持**：自动补全和错误检查
- **用户不可修改**：提高应用安全性

### 2. config.py（配置管理类）

**位置**：`auto_updater/config.py`

**用途**：提供配置管理的高级接口，支持配置验证、版本比较等功能。

**主要功能**：
```python
from auto_updater.config import get_config

# 获取配置实例
config = get_config()

# 获取配置信息
version = config.current_version
repo = config.github_repo

# 版本比较
result = config.compare_versions("2.0.1", "2.0.0")

# 检查是否需要更新
should_update = config.is_newer_version("2.0.1", "2.0.0")
```

## 🔧 配置修改方法

### ⚠️ 重要提示

由于采用Python常量配置系统，**普通用户无法修改配置**。如需修改配置，需要：

1. **开发者修改**：修改`config_constants.py`中的常量值
2. **重新打包**：运行`python 打包工具.py`生成新的exe文件
3. **重新签名**：对新exe文件进行数字签名（如需要）

### 📝 配置修改步骤（开发者）

1. **打开配置文件**：
   ```bash
   # 编辑配置常量文件
   notepad auto_updater/config_constants.py
   ```

2. **修改配置值**：
   ```python
   # 示例：修改版本号
   CURRENT_VERSION: str = "2.0.2"

   # 示例：修改GitHub仓库
   GITHUB_OWNER: str = "new-owner"
   GITHUB_REPO: str = "new-repo"

   # 示例：修改更新检查间隔
   UPDATE_CHECK_INTERVAL_DAYS: int = 7
   ```

3. **验证配置**：
   ```python
   from auto_updater.config_constants import validate_config

   if validate_config():
       print("✅ 配置验证通过")
   else:
       print("❌ 配置验证失败")
   ```

4. **重新打包**：
   ```bash
   python 打包工具.py
   ```

## 📋 配置参数详解

### 🏷️ 应用标识配置

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `APP_NAME` | str | "PDF重命名工具" | 应用程序名称 |
| `APP_EXECUTABLE` | str | "PDF_Rename_Operation.exe" | 可执行文件名 |

### 🌐 GitHub仓库配置

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `GITHUB_OWNER` | str | "chen-huai" | GitHub仓库所有者 |
| `GITHUB_REPO` | str | "Temu_PDF_Rename_APP" | GitHub仓库名称 |
| `GITHUB_API_BASE` | str | "https://api.github.com" | GitHub API基础URL |

### 🔢 版本管理配置

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `CURRENT_VERSION` | str | "2.0.1" | 当前版本号 |
| `UPDATE_CHECK_INTERVAL_DAYS` | int | 30 | 更新检查间隔（天） |
| `AUTO_CHECK_ENABLED` | bool | True | 是否启用自动检查 |

### ⚙️ 更新行为配置

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `MAX_BACKUP_COUNT` | int | 3 | 最大备份文件数量 |
| `DOWNLOAD_TIMEOUT` | int | 300 | 下载超时时间（秒） |
| `MAX_RETRIES` | int | 3 | 最大重试次数 |
| `AUTO_RESTART` | bool | True | 更新后是否自动重启 |

### 🌐 网络请求配置

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `REQUEST_HEADERS` | dict | 见上方 | HTTP请求头配置 |

## 🚨 配置验证

### 自动验证功能

系统提供自动配置验证功能，确保配置信息的完整性和正确性：

```python
from auto_updater.config_constants import validate_config

# 运行配置验证
if validate_config():
    print("✅ 所有配置验证通过")
else:
    print("❌ 配置验证失败")
    print("请检查config_constants.py中的配置信息")
```

### 验证内容

- ✅ 必要常量存在性检查
- ✅ 版本号格式验证
- ✅ URL格式正确性验证
- ✅ 配置类型匹配检查

## 📊 配置历史和变更

### v2.0.0+：Python常量配置系统

- **2025-10-28**：完成配置文件Python化改造
- **变更内容**：
  - 新增`config_constants.py`作为配置数据源
  - 修改`config.py`使用Python常量
  - 移除所有JSON配置文件依赖
  - 简化打包工具，无需处理外部配置文件

### v1.x.x：JSON配置系统

- 使用`updater_config.json`作为主配置文件
- 需要外部文件支持
- 用户可以修改配置文件

## 📝 数字签名配置系统

### 概述

数字签名功能采用**智能配置加载系统**，支持多种配置格式和优先级，确保签名功能的灵活性和可靠性。

### 配置文件层次结构

#### 1. Python配置文件 (推荐)

**位置**: `code_signer/examples/project_config.py`

**特点**:
- ✅ 类型安全，支持IDE自动补全
- ✅ 配置验证，自动检查完整性
- ✅ 支持复杂配置逻辑
- ✅ 编译时错误检查

**基本结构**:
```python
# -*- coding: utf-8 -*-
"""
PDF重命名工具项目专用配置
"""
from code_signer.config import SigningConfig, CertificateConfig, ToolConfig

# 创建配置实例
CONFIG = SigningConfig()

# 基本配置
CONFIG.enabled = True
CONFIG.default_certificate = "pdf_rename_operation"
CONFIG.timestamp_server = "http://timestamp.digicert.com"
CONFIG.hash_algorithm = "sha256"

# 证书配置
pdf_cert = CertificateConfig(
    name="pdf_rename_operation",
    sha1="144ac4069565211ab67d25a9d6d33af0e18e511e",
    subject="CN=PDF_Rename_Operation...",
    issuer="CN=TUVSUD-IssuingCA...",
    valid_from="2025-10-15",
    valid_to="2027-10-15",
    description="TUVSUD颁发的PDF重命名工具专用证书"
)

CONFIG.add_certificate(pdf_cert)
```

#### 2. JSON配置文件 (兼容)

**位置**: `signature_config.json`

**特点**:
- ✅ 向后兼容，支持旧系统
- ✅ 简单易读的格式
- ✅ 易于程序化生成和解析
- ✅ 跨语言支持

**基本结构**:
```json
{
  "signature": {
    "enabled": true,
    "default_certificate": "pdf_rename_operation",
    "timestamp_server": "http://timestamp.digicert.com",
    "hash_algorithm": "sha256",
    "certificates": {
      "pdf_rename_operation": {
        "name": "PDF_Rename_Operation证书",
        "sha1": "144ac4069565211ab67d25a9d6d33af0e18e511e",
        "subject": "CN=PDF_Rename_Operation...",
        "issuer": "CN=TUVSUD-IssuingCA...",
        "valid_from": "2025-10-15",
        "valid_to": "2027-10-15"
      }
    },
    "signing_tools": {
      "signtool": {
        "enabled": true,
        "path": "auto",
        "priority": 1,
        "description": "Windows SDK signtool.exe"
      },
      "powershell": {
        "enabled": true,
        "priority": 2,
        "description": "PowerShell Set-AuthenticodeSignature"
      }
    },
    "policies": {
      "verify_before_sign": true,
      "backup_before_sign": false,
      "auto_retry": true,
      "max_retries": 3,
      "record_signing_history": true
    },
    "file_paths": {
      "search_patterns": [
        "dist/*.exe",
        "*.exe",
        "build/*.exe"
      ],
      "exclude_patterns": [
        "*.tmp.exe",
        "*_unsigned.exe",
        "*_backup*.exe"
      ],
      "record_directory": "./signature_records"
    },
    "output": {
      "verbose": true,
      "save_records": true,
      "record_format": "json",
      "create_log_file": true
    }
  }
}
```

### 配置加载优先级

系统按以下优先级加载配置：

1. **指定配置路径**: `load_signing_config("/path/to/config.py")`
2. **项目配置**: `code_signer/examples/project_config.py`
3. **JSON配置**: `signature_config.json`
4. **默认配置**: 内置的安全默认值

### 配置验证机制

#### 自动验证内容
- ✅ 证书SHA1不为空
- ✅ 默认证书存在于证书列表
- ✅ 哈希算法有效性 (sha1/sha256)
- ✅ 最大重试次数大于0
- ✅ 工具名称不为空

#### 验证失败处理
```python
# 配置验证失败时，系统会：
1. 显示详细的错误信息
2. 提供修复建议
3. 使用安全的默认值继续运行
4. 记录验证日志
```

### 使用方式

#### 编程接口

```python
# 方式1：智能加载 (推荐)
from code_signer.config_loader import load_signing_config
config = load_signing_config()

# 方式2：指定配置文件
config = load_signing_config("my_config.py")

# 方式3：传统方式 (兼容)
from signing_tool import SigningTool
tool = SigningTool()  # 自动加载最佳配置
```

#### 配置验证

```python
# 验证配置完整性
errors = config.validate()
if errors:
    print("配置验证失败:")
    for error in errors:
        print(f"  - {error}")
else:
    print("配置验证通过")
```

### 配置组件详解

#### 1. 基本配置 (SigningConfig)
```python
CONFIG.enabled = True                    # 是否启用签名功能
CONFIG.default_certificate = "default"   # 默认证书名称
CONFIG.timestamp_server = "http://timestamp.digicert.com"
CONFIG.hash_algorithm = "sha256"         # 哈希算法 (sha1/sha256)
```

#### 2. 证书配置 (CertificateConfig)
```python
cert = CertificateConfig(
    name="certificate_name",        # 证书名称 (必需)
    sha1="abc123...",               # SHA1指纹 (必需)
    subject="CN=My App",           # 证书主题
    issuer="CN=CA",               # 证书颁发者
    valid_from="2025-01-01",       # 有效期开始
    valid_to="2027-01-01",         # 有效期结束
    description="证书描述"          # 证书描述
)
```

#### 3. 工具配置 (ToolConfig)
```python
tool = ToolConfig(
    name="signtool",               # 工具名称 (必需)
    enabled=True,                  # 是否启用
    path="auto",                   # 工具路径 ("auto"=自动查找)
    priority=1,                    # 优先级 (数字越小优先级越高)
    description="工具描述"           # 工具描述
)
```

#### 4. 策略配置 (PoliciesConfig)
```python
CONFIG.policies = PoliciesConfig(
    verify_before_sign=True,      # 签名前验证
    backup_before_sign=False,     # 签名前备份
    auto_retry=True,              # 自动重试
    max_retries=3,                # 最大重试次数
    record_signing_history=True   # 记录历史
)
```

### 故障排除

#### 常见配置错误

**错误**: `证书SHA1不能为空`
```python
# 解决方案：确保SHA1字段有值
cert = CertificateConfig(
    name="my_cert",
    sha1="144ac4069565211ab67d25a9d6d33af0e18e511e",  # 必须提供
    subject="CN=My App"
)
```

**错误**: `默认证书未在证书列表中找到`
```python
# 解决方案：添加证书到配置
CONFIG.add_certificate(cert)
CONFIG.default_certificate = cert.name  # 确保名称匹配
```

**错误**: `SigningConfig object has no attribute 'max_retries'`
```python
# 解决方案：正确访问嵌套属性
# 错误方式
print(config.max_retries)

# 正确方式
print(config.policies.max_retries)
```

### 最佳实践

#### 1. 配置管理
- 使用Python配置文件获得类型安全
- 定期运行配置验证
- 备份重要配置文件
- 使用版本控制管理配置变更

#### 2. 证书管理
- 定期检查证书有效期
- 在证书到期前更新配置
- 安全保管证书信息
- 使用描述性的证书名称

#### 3. 工具配置
- 配置多个签名工具作为备选
- 设置合理的优先级
- 测试每个工具的可用性
- 记录工具路径和版本

## 🔍 故障排除

### 常见问题

**Q: 如何确认当前使用的配置？**
```python
# 应用程序配置
from auto_updater.config import get_config
config = get_config()
print(f"当前版本: {config.current_version}")
print(f"GitHub仓库: {config.github_repo}")

# 签名配置
from code_signer.config_loader import load_signing_config, get_config_load_info
signing_config = load_signing_config()
load_info = get_config_load_info()
print(f"签名配置源: {load_info['load_source']}")
print(f"默认证书: {signing_config.default_certificate}")
```

**Q: 配置修改后不生效？**
- 确认已修改`config_constants.py`
- 重新运行打包工具生成新的exe文件
- 使用新的exe文件替换旧文件

**Q: 配置验证失败？**
- 检查`config_constants.py`中的常量定义
- 确认所有必要的常量都已定义
- 检查版本号格式是否正确

**Q: 版本号格式错误？**
版本号应遵循语义化版本格式：`主版本.次版本.修订版本`（如：2.0.1）

## 📚 相关文档

- [05-自动更新功能使用教程.md](./05-自动更新功能使用教程.md) - 自动更新配置和使用
- [07-版本更新清单.md](./07-版本更新清单.md) - 版本发布记录和变更历史
- [CLAUDE.md](./CLAUDE.md) - 项目架构和技术文档

---

*配置文件说明版本：2.0 | 最后更新：2025-10-28 | 适用版本：v2.0.0+*