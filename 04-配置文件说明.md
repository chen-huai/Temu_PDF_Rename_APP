# 配置文件说明

## 概述

项目采用Config类统一配置管理架构，通过配置文件驱动所有核心功能，包括版本管理、自动更新、数字签名等。

## 配置文件清单

### 1. updater_config.json（主配置文件）
**位置**：`项目根目录/updater_config.json`

**用途**：应用程序的主配置文件，包含应用信息、仓库配置、版本管理、更新设置等。

**主要内容**：
```json
{
  "app": {
    "name": "PDF重命名工具",
    "executable": "PDF_Rename_Operation.exe"
  },
  "repository": {
    "owner": "chen-huai",
    "repo": "Temu_PDF_Rename_APP",
    "api_base": "https://api.github.com"
  },
  "version": {
    "current": "2.0.0",
    "check_interval_days": 30,
    "auto_check_enabled": true
  },
  "update": {
    "backup_count": 3,
    "download_timeout": 300,
    "max_retries": 3,
    "auto_restart": true
  },
  "network": {
    "request_headers": {
      "Accept": "application/vnd.github.v3+json",
      "User-Agent": "App-Updater/1.0"
    }
  }
}
```

**关键变化**：
- **版本管理**：版本号直接存储在`version.current`字段，无需独立的version.txt文件
- **Config类管理**：通过`auto_updater/config.py`中的Config类统一管理
- **单一数据源**：作为版本信息的唯一来源

### 2. update_state.json（更新状态文件）
**位置**：`auto_updater/update_state.json`

**用途**：记录自动更新功能的状态信息，如最后检查时间、更新历史等。

**主要内容**：
```json
{
  "last_check_date": "2025-10-27T15:00:00.000000"
}
```

**特点**：
- 自动维护，无需手动修改
- 记录更新检查的历史信息
- 用于控制检查频率和更新策略

### 3. signature_config.json（数字签名配置文件）
**位置**：`项目根目录/signature_config.json`

**用途**：数字签名功能的配置文件，包含证书信息、签名工具配置、策略设置等。

**主要内容**：
```json
{
  "signature": {
    "enabled": true,
    "default_certificate": "pdf_rename_operation",
    "timestamp_server": "http://timestamp.digicert.com",
    "hash_algorithm": "sha256",
    "certificates": {
      "pdf_rename_operation": {
        "name": "PDF_Rename_Operation证书",
        "sha1": "144ac4069565211ab67d25a9d6d33af0e18e511e",
        "subject": "CN=PDF_Rename_Operation...",
        "description": "TUVSUD颁发的PDF重命名工具专用证书"
      }
    },
    "signing_tools": {
      "signtool": {"enabled": true, "priority": 1},
      "powershell": {"enabled": true, "priority": 2},
      "osslsigncode": {"enabled": true, "priority": 3}
    }
  }
}
```

**功能**：
- 证书管理和配置
- 签名工具优先级设置
- 签名策略和安全配置

## Config类统一配置管理

### Config类API使用

#### 1. 获取配置实例
```python
from auto_updater.config import get_config

# 获取全局配置实例
config = get_config()
```

#### 2. 版本管理
```python
# 获取当前版本
current_version = config.current_version
print(f"当前版本: {current_version}")

# 更新版本号（自动保存到配置文件）
success = config.update_current_version("2.1.0")
if success:
    print("版本更新成功")

# 版本比较
is_newer = config.is_newer_version("v2.1.0", "2.0.0")  # True
result = config.compare_versions("2.0.0", "2.1.0")       # -1

# 验证版本格式
is_valid = config.is_valid_version("2.1.0")             # True
```

#### 3. 更新检查管理
```python
# 检查是否需要更新检查
should_check = config.should_check_for_updates()

# 更新最后检查时间
config.update_last_check_time()

# 获取检查间隔（天）
interval = config.update_check_interval_days
```

#### 4. GitHub仓库配置
```python
# 获取GitHub仓库信息
owner = config.github_owner          # "chen-huai"
repo = config.github_repo            # "Temu_PDF_Rename_APP"
api_base = config.github_api_base    # "https://api.github.com"

# 获取最新Release URL
release_url = config.github_latest_release_url
```

## 配置文件管理

### Config类优势
- **单一数据源**：版本信息仅在updater_config.json中维护
- **自动同步**：版本更新时自动保存到配置文件
- **零错误**：避免手动同步多个文件导致的版本不一致
- **内置验证**：版本号格式验证和比较逻辑
- **状态管理**：更新检查状态自动持久化

### 配置文件修改注意事项

1. **updater_config.json**：
   - **版本号修改**：通过Config类API修改，确保数据一致性
   - **仓库配置**：修改时需确保GitHub仓库存在且可访问
   - **更新设置**：可根据需要调整检查间隔和更新策略
   - **网络配置**：一般不需要修改，除非有特殊代理需求

2. **update_state.json**：
   - **自动维护**：完全由程序自动维护，无需手动修改
   - **状态持久化**：记录更新检查历史和状态信息
   - **重置方法**：如需重置检查时间，可删除该文件重新生成

3. **signature_config.json**：
   - **证书管理**：配置数字签名证书信息和参数
   - **工具配置**：设置签名工具的优先级和路径
   - **安全策略**：配置签名验证和安全检查策略

### 手动修改版本号
如果需要手动修改版本号：

```python
from auto_updater.config import get_config

config = get_config()
config.update_current_version("2.1.0")
```

或者直接编辑updater_config.json：
```json
{
  "version": {
    "current": "2.1.0"
  }
}
```

## 配置验证

### 检查配置完整性
```python
# 运行配置检查脚本
python -c "
from auto_updater.config import get_config
import json

try:
    # 检查Config类功能
    config = get_config()
    print(f'✓ 当前版本: {config.current_version}')
    print(f'✓ GitHub仓库: {config.github_owner}/{config.github_repo}')
    print(f'✓ 检查间隔: {config.update_check_interval_days}天')

    # 验证版本比较功能
    test_result = config.is_newer_version('v2.1.0', '2.0.0')
    print(f'✓ 版本比较功能正常: {test_result}')

except Exception as e:
    print(f'✗ 配置系统错误: {e}')

# 检查配置文件格式
try:
    with open('updater_config.json', 'r', encoding='utf-8') as f:
        main_config = json.load(f)
    print('✓ updater_config.json 格式正确')
except Exception as e:
    print(f'✗ updater_config.json 错误: {e}')

# 检查签名配置
try:
    with open('signature_config.json', 'r', encoding='utf-8') as f:
        sig_config = json.load(f)
    print('✓ signature_config.json 格式正确')
except Exception as e:
    print(f'✗ signature_config.json 错误: {e}')
"
```

## 常见问题

### Q: 修改配置后不生效？
A: 重启应用程序，确保配置文件被重新加载。Config类会自动重新读取配置文件。

### Q: 如何更新版本号？
A: 使用Config类API：`config.update_current_version("2.1.0")`，避免手动编辑多个文件。

### Q: GitHub连接失败？
A: 检查updater_config.json中的repository.owner和repository.repo配置是否正确。

### Q: 数字签名配置错误？
A: 检查signature_config.json中的证书信息和签名工具配置，确保证书有效。

### Q: Config类初始化失败？
A: 确保updater_config.json文件存在且格式正确，检查文件权限是否允许读取。

---

**文档版本**：1.0
**最后更新**：2025-10-27